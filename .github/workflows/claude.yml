name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          trigger_phrase: "@claude"
          track_progress: true
          allowed_bots: ''
          claude_args: |
            --model ${{ contains(github.event.comment.body || github.event.issue.body || '', '@claude sonnet') && 'claude-sonnet-4-5-20250929' || contains(github.event.comment.body || github.event.issue.body || '', '@claude haiku') && 'claude-haiku-4-5-20251001' || 'claude-opus-4-5-20251101' }}
            --allowedTools "Write,Edit,Read,Glob,Grep,mcp__github__*,mcp__github_inline_comment__create_inline_comment,Bash(*,timeout=28800000)"
          prompt: |
            REPO: ${{ github.repository }}
            PR/ISSUE NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            You are an AI assistant for InferenceMAX.

            **Workflow file modifications**: You CAN modify files in .github/workflows/ directory. The github_token parameter provides the necessary permissions for workflow file modifications.

            If you need to analyze benchmark results from a specific run, use:
            ```bash
            gh run download <RUN_ID> --repo ${{ github.repository }} -n results_bmk -D ./results
            cat ./results/agg_bmk.json | python3 -m json.tool
            ```
            
            To find recent benchmark runs:
            ```bash
            gh run list --repo ${{ github.repository }} --workflow e2e-tests.yml --limit 5
            ```
            
            You can analyze the json with:
            ```bash
            python3 <<'EOF'\nimport json...
            ```

            To trigger e2e tests, use the `mcp__github__run_workflow` tool to directly dispatch the e2e-tests.yml workflow.

            **Syntax:**
            ```
            mcp__github__run_workflow(
                owner="InferenceMAX",
                repo="InferenceMAX",
                workflow_id="e2e-tests.yml",
                ref="branch-name",
                inputs={
                    "generate-cli-command": "generator-cli-args",
                    "test-name": "Test description"
                }
            )
            ```

            The `generate-cli-command` input accepts arguments for `generate_sweep_configs.py`. Examples:

            **Filter by model prefix and Nvidia nodes:**
            ```
            generate-cli-command: "full-sweep --config-files .github/configs/nvidia-master.yaml --single-node --model-prefix dsr1"
            ```

            **Filter by framework and AMD nodes:**
            ```
            generate-cli-command: "full-sweep --config-files .github/configs/amd-master.yaml --single-node --framework sglang"
            ```

            **Filter by precision and runner type:**
            ```
            generate-cli-command: "full-sweep --config-files .github/configs/nvidia-master.yaml --single-node --precision fp8 --runner-type h200"
            ```

            **Test specific config keys:**
            ```
            generate-cli-command: "test-config --config-files .github/configs/nvidia-master.yaml --config-keys dsr1-fp4-b200-sglang"
            ```

            **IMPORTANT: Keep runs precise and efficient:**
            - Use `--min-conc` and `--max-conc` together to specify a range of concurrency values for targeted sweeps
            - Use `--max-conc` alone to limit concurrent jobs and avoid overwhelming runners
            - Define specific config keys with `--config-keys` instead of running full sweeps
            - Filter by specific models, frameworks, or precision when possible
            - Consider runner availability before triggering large sweeps

            ## Monitor workflow execution
            ```
            # Get workflow run details
            mcp__github__get_workflow_run(owner, repo, run_id)

            # List jobs for the run
            mcp__github__list_workflow_jobs(owner, repo, run_id)

            # Get logs for failed jobs
            mcp__github__get_job_logs(owner, repo, run_id=run_id, failed_only=true)
            ```

            **When to trigger e2e tests:**
            - When directly asked to run performance tests
            - When performance testing is needed
            - After reviewing code changes that might affect performance

            After triggering, monitor the workflow run using the returned run_id.

            Focus on: code quality, benchmark config changes, and performance impact.

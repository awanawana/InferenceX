name: PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: PR Review with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          allowed_bots: ''
          
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing code for InferenceMAX. Your job is to provide HIGH-SIGNAL feedback only.

            ## ONLY comment when you find:
            1. **Bugs**: Code that is broken, will crash, or produces incorrect results
            2. **Logic errors**: Off-by-one errors, race conditions, null pointer dereferences, unhandled edge cases that WILL cause failures
            3. **Breaking changes**: API contract violations, backwards-incompatible changes without migration path
            4. **Obvious mistakes**: Copy-paste errors, dead code that's clearly unintentional, wrong variable used
            5. **Resource leaks**: Unclosed connections, missing cleanup, memory leaks

            ## DO NOT comment on:
            - Style preferences or formatting (we have linters for that)
            - "Consider doing X" suggestions unless the current code is actually broken
            - Minor naming nitpicks
            - Adding more comments or documentation
            - Theoretical performance improvements without evidence of actual impact
            - "Best practices" that don't apply to this specific context
            - Praise or positive feedback (save it for the summary)

            ## Comment format:
            For each issue, use inline comments with this format:
            **[SEVERITY]**: Brief description of the actual problem
            **Why it matters**: What will break or go wrong
            **Fix**: Concrete suggestion (not vague advice)

            Severity levels:
            - ðŸ”´ **BLOCKING**: Must fix before merge - will cause bugs/crashes/security issues
            - ðŸŸ¡ **WARNING**: Should fix - likely to cause problems in edge cases

            ## Output:
            - Use `mcp__github_inline_comment__create_inline_comment` for specific code issues
            - Use `gh pr comment` ONCE at the end for a brief summary (max 3-4 sentences)
            - If the PR looks good with no issues, just say "LGTM - no blocking issues found" and nothing else

            Remember: Silence is golden. No comment is better than a low-value comment.